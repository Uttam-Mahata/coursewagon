<div class="course-review-form bg-white rounded-lg shadow-md p-6 max-w-2xl">
  <!-- Loading State -->
  <div *ngIf="checking" class="text-center py-8">
    <fa-icon [icon]="faSpinner" [spin]="true" class="text-2xl text-blue-500"></fa-icon>
    <p class="text-gray-600 mt-2">Checking eligibility...</p>
  </div>

  <!-- Not Eligible Message -->
  <div *ngIf="!checking && eligibility && !eligibility.can_review" class="text-center py-8">
    <div class="bg-yellow-50 border border-yellow-200 rounded-lg p-6">
      <p class="text-yellow-800 font-medium mb-2">Unable to submit review</p>
      <p class="text-yellow-700">{{ eligibility.reason }}</p>
      <div *ngIf="eligibility.progress_percentage !== undefined" class="mt-4">
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-blue-500 h-2 rounded-full transition-all"
               [style.width.%]="eligibility.progress_percentage"></div>
        </div>
        <p class="text-sm text-gray-600 mt-2">
          Progress: {{ eligibility.progress_percentage | number:'1.0-0' }}%
          (Need {{ eligibility.minimum_required }}%)
        </p>
      </div>
      <button
        (click)="onCancel()"
        class="mt-4 px-4 py-2 bg-gray-200 text-gray-700 rounded-md hover:bg-gray-300 transition"
      >
        Close
      </button>
    </div>
  </div>

  <!-- Review Form -->
  <div *ngIf="!checking && canSubmit" [formGroup]="reviewForm">
    <!-- Header -->
    <div class="mb-6">
      <h3 class="text-xl font-semibold text-gray-800">
        {{ existingReview ? 'Edit Your Review' : 'Write a Review' }}
      </h3>
      <p class="text-sm text-gray-600 mt-1">Share your experience with this course</p>
    </div>

    <!-- Rating Section -->
    <div class="mb-6">
      <label class="block text-sm font-medium text-gray-700 mb-2">
        Your Rating <span class="text-red-500">*</span>
      </label>
      <div class="flex items-center gap-2">
        <app-star-rating
          [rating]="selectedRating"
          [interactive]="true"
          [size]="'lg'"
          (ratingChange)="onRatingChange($event)"
        ></app-star-rating>
      </div>
    </div>

    <!-- Review Text Section -->
    <div class="mb-6">
      <label for="reviewText" class="block text-sm font-medium text-gray-700 mb-2">
        Your Review (Optional)
      </label>
      <textarea
        id="reviewText"
        formControlName="reviewText"
        rows="5"
        placeholder="Share your thoughts about this course..."
        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent resize-none"
        [class.border-red-500]="reviewForm.get('reviewText')?.invalid && reviewForm.get('reviewText')?.touched"
      ></textarea>
      <div class="flex justify-between items-center mt-1">
        <span
          class="text-xs"
          [class.text-gray-500]="charactersRemaining > 50"
          [class.text-yellow-600]="charactersRemaining <= 50 && charactersRemaining > 0"
          [class.text-red-600]="charactersRemaining <= 0"
        >
          {{ characterCount }} / {{ maxCharacters }} characters
        </span>
        <span *ngIf="reviewForm.get('reviewText')?.invalid && reviewForm.get('reviewText')?.touched"
              class="text-xs text-red-600">
          Maximum {{ maxCharacters }} characters exceeded
        </span>
      </div>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="mb-4 p-3 bg-red-50 border border-red-200 rounded-md">
      <p class="text-sm text-red-700">{{ error }}</p>
    </div>

    <!-- Success Message -->
    <div *ngIf="success" class="mb-4 p-3 bg-green-50 border border-green-200 rounded-md">
      <p class="text-sm text-green-700 flex items-center gap-2">
        <fa-icon [icon]="faCheck"></fa-icon>
        {{ success }}
      </p>
    </div>

    <!-- Action Buttons -->
    <div class="flex justify-between items-center">
      <div>
        <button
          *ngIf="existingReview"
          type="button"
          (click)="onDelete()"
          [disabled]="loading"
          class="px-4 py-2 text-red-600 hover:text-red-700 hover:bg-red-50 rounded-md transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Delete Review
        </button>
      </div>

      <div class="flex gap-2">
        <button
          type="button"
          (click)="onCancel()"
          [disabled]="loading"
          class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          Cancel
        </button>
        <button
          type="submit"
          (click)="onSubmit()"
          [disabled]="loading || reviewForm.invalid"
          class="px-6 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2"
        >
          <fa-icon *ngIf="loading" [icon]="faSpinner" [spin]="true"></fa-icon>
          {{ loading ? 'Submitting...' : (existingReview ? 'Update Review' : 'Submit Review') }}
        </button>
      </div>
    </div>
  </div>
</div>
